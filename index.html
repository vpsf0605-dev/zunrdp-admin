<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZUNRDP CLOUD - FULL SYSTEM</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { 
            --primary: #00f2ea; --accent: #ff0050; --bg: #050505; 
            --card: #121212; --text: #fff; --success: #00ff9d; --sub: #888;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Layout */
        .app-header { height: 70px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); border-bottom: 1px solid #222; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 800; font-size: 24px; letter-spacing: 1px; color: #fff; }
        .logo span { color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .user-pill { background: #1a1a1a; padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; border: 1px solid #333; }
        .avatar { width: 28px; height: 28px; background: var(--primary); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; }

        .content { flex: 1; overflow-y: auto; padding: 20px 15px 100px 15px; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; margin-bottom: 20px; border: 1px solid #222; }

        /* Stats & Inputs */
        .stat-container { display: flex; gap: 15px; margin-top: 15px; }
        .stat-box { flex: 1; background: #000; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #333; }
        .stat-value { font-size: 20px; font-weight: 800; display: block; }

        .inp-box { background: #000; border: 1px solid #333; border-radius: 12px; padding: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
        .inp-box input, .inp-box select { background: transparent; border: none; color: #fff; width: 100%; font-size: 15px; font-family: inherit; }
        .inp-box select option { background: #111; color: #fff; }

        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; text-transform: uppercase; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #333; color: var(--sub); }
        .btn:active { transform: scale(0.96); }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: rgba(10,10,10,0.98); border-top: 1px solid #222; display: flex; justify-content: space-around; padding-bottom: env(safe-area-inset-bottom); backdrop-filter: blur(20px); z-index: 100; }
        .nav-link { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: #555; font-weight: 600; text-decoration: none; }
        .nav-link i { font-size: 26px; margin-bottom: 4px; }
        .nav-link.active { color: var(--primary); }

        /* Modal Auth */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; align-items: flex-end; }
        .modal.open { display: flex; }
        .sheet { background: #111; width: 100%; border-radius: 30px 30px 0 0; padding: 35px 25px; border-top: 1px solid #333; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .auth-tabs { display: flex; background: #000; padding: 5px; border-radius: 12px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 13px; font-weight: 800; color: #555; cursor: pointer; }
        .tab.active { background: #222; color: #fff; border-radius: 8px; }

        .hidden { display: none !important; }
        .admin-badge { background: rgba(255,0,80,0.2); color: var(--accent); padding: 2px 8px; border-radius: 4px; font-size: 10px; border: 1px solid var(--accent); margin-left: 5px; font-weight: 800; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="logo">ZUNRDP<span>CLOUD</span></div>
        <div class="user-pill" onclick="handleProfileClick()">
            <div id="u-avatar" class="avatar">?</div>
            <div id="u-name" style="margin-left:8px; font-weight:600; font-size:13px;">Đăng nhập</div>
        </div>
    </header>

    <div class="content">
        <div id="view-home" class="page">
            <div class="card" style="background: linear-gradient(135deg, #001f3f, #000); border: 2px solid var(--primary); text-align:center; padding: 40px 20px;">
                <h1 style="font-size: 32px; font-weight: 800;">ZUN <span style="color:var(--primary)">CLOUD</span></h1>
                <p style="color:var(--sub); font-size: 14px; margin-bottom: 25px;">Hệ thống Windows 2025 Automation</p>
                <button class="btn btn-primary" onclick="switchView('store')">XEM CÁC GÓI THUÊ</button>
            </div>
            <div class="card">
                <h4><i class="fas fa-info-circle text-primary"></i> Giới thiệu</h4>
                <p style="font-size:13px; color:var(--sub); margin-top:10px; line-height:1.6">Chúng tôi cung cấp giải pháp VPS Windows tự động hoàn toàn qua GitHub Actions, cam kết bảo mật và ổn định 99.9%.</p>
            </div>
        </div>

        <div id="view-store" class="page hidden">
            <h2 style="margin-bottom:20px; font-weight:800;">Chọn Gói VPS</h2>
            <div id="product-list-render"></div>
        </div>

        <div id="view-vps" class="page hidden">
            <h2 style="margin-bottom:20px; font-weight:800;">Máy Chủ Của Tôi</h2>
            <div id="vps-render"></div>
        </div>

        <div id="view-wallet" class="page hidden">
            <div class="card" style="background: linear-gradient(to right, #004d40, #00695c); padding: 30px;">
                <div style="font-size:12px; opacity:0.8; text-transform: uppercase;">Số dư ví</div>
                <div id="w-balance" style="font-size: 36px; font-weight: 800; margin: 5px 0;">0 VNĐ</div>
                <div style="font-size: 13px; display:flex; align-items:center; gap:10px;">
                    <span id="w-email">...</span> <span id="w-admin"></span>
                </div>
            </div>

            <div class="card">
                <h4>Nạp tiền Giftcode</h4>
                <div class="inp-box" style="margin-top:15px;"><input type="text" id="gift-code-input" placeholder="Nhập mã nạp tiền của bạn..."></div>
                <button class="btn btn-primary" onclick="useGiftcode()">XÁC NHẬN NẠP TIỀN</button>
                <div style="font-size:10px; color:#444; margin-top:10px; text-align:center;"></div>
            </div>

            <div id="admin-panel" class="hidden">
                <h2 style="color:var(--accent); margin: 30px 0 20px; font-weight:800;">ADMIN CONTROL</h2>

                <div class="card" style="border: 1px solid var(--accent);">
                    <h4>Tạo Giftcode Mới</h4>
                    <div class="inp-box" style="margin-top:15px;"><input id="adm-gift-code" placeholder="Mã nạp (vd: ZUN_100K)"></div>
                    <div class="inp-box">
                        <select id="adm-gift-val">
                            <option value="">-- Chọn mệnh giá --</option>
                            <option value="10000">10.000 VNĐ</option>
                            <option value="20000">20.000 VNĐ</option>
                            <option value="50000">50.000 VNĐ</option>
                            <option value="100000">100.000 VNĐ</option>
                            <option value="200000">200.000 VNĐ</option>
                            <option value="500000">500.000 VNĐ</option>
                        </select>
                    </div>
                    <button class="btn" style="background:var(--accent); color:#fff" onclick="adminCreateGiftcode()">TẠO MÃ GIFTCODE</button>
                </div>

                <div class="card" style="border: 1px solid var(--primary);">
                    <h4>Cấu Hình Gói VPS</h4>
                    <div class="inp-box"><input id="adm-p-name" placeholder="Tên gói (vd: Windows 2025)"></div>
                    <div class="inp-box"><input id="adm-p-price" type="number" placeholder="Giá bán / Giờ"></div>
                    <div class="inp-box"><input id="adm-p-token" placeholder="GitHub Token (ghp_...)"></div>
                    <div class="inp-box"><input id="adm-p-repo" placeholder="Repo (User/Repo)"></div>
                    <button class="btn btn-primary" onclick="adminCreateProduct()">CẬP NHẬT GÓI HÀNG</button>
                </div>

                <h4 style="margin:20px 0 10px; padding-left:10px;">Quản lý toàn bộ máy chủ</h4>
                <div id="admin-vps-all"></div>
            </div>

            <button class="btn btn-outline" style="margin-top:20px;" onclick="doLogout()">ĐĂNG XUẤT</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-link active" onclick="switchView('home', this)"><i class="fas fa-home"></i>Home</div>
        <div class="nav-link" onclick="switchView('store', this)"><i class="fas fa-server"></i>Store</div>
        <div class="nav-link" onclick="switchView('vps', this)"><i class="fas fa-desktop"></i>Máy</div>
        <div class="nav-link" onclick="switchView('wallet', this)"><i class="fas fa-wallet"></i>Ví</div>
    </nav>

    <div class="modal" id="auth-modal">
        <div class="sheet">
            <div class="auth-tabs">
                <div class="tab active" id="t-login" onclick="setAuthMode('login')">ĐĂNG NHẬP</div>
                <div class="tab" id="t-reg" onclick="setAuthMode('register')">ĐĂNG KÝ</div>
            </div>
            <div class="inp-box"><i class="fas fa-user"></i><input id="auth-u" placeholder="Tên tài khoản..."></div>
            <div class="inp-box"><i class="fas fa-lock"></i><input id="auth-p" type="password" placeholder="Mật khẩu..."></div>
            <button class="btn btn-primary" onclick="runAuth()">TIẾP TỤC</button>
            <button class="btn btn-outline" style="margin-top:10px;" onclick="closeAuth()">HỦY BỎ</button>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBrKWSjYj7x8gUKPXUyHKTidAFtOIa5ul4",
            authDomain: "zunrdp.firebaseapp.com",
            databaseURL: "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "zunrdp",
            storageBucket: "zunrdp.firebasestorage.app",
            messagingSenderId: "147267232968",
            appId: "1:147267232968:web:4354280b9db538026831fd"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;
        let isAdmin = false;

        const toEmail = (u) => u.includes('@') ? u : u + "@zun.com";
        const toName = (e) => e.replace("@zun.com", "");

        function openAuth() { document.getElementById('auth-modal').classList.add('open'); }
        function closeAuth() { document.getElementById('auth-modal').classList.remove('open'); }
        function setAuthMode(m) { 
            document.getElementById('t-login').className = m === 'login' ? 'tab active' : 'tab'; 
            document.getElementById('t-reg').className = m === 'register' ? 'tab active' : 'tab'; 
        }

        async function runAuth() {
            const u = document.getElementById('auth-u').value.trim();
            const p = document.getElementById('auth-p').value.trim();
            if(!u || !p) return alert("Điền đủ thông tin!");
            const e = toEmail(u);
            const isLogin = document.getElementById('t-login').classList.contains('active');
            try {
                if(isLogin) { await auth.signInWithEmailAndPassword(e, p); closeAuth(); }
                else { 
                    const res = await auth.createUserWithEmailAndPassword(e, p);
                    await db.ref('users/' + res.user.uid).set({ email: e, balance: 0, role: 'user', banned: false });
                    closeAuth();
                }
            } catch(err) { alert(err.message); }
        }

        auth.onAuthStateChanged(user => {
            if(user) {
                db.ref('users/' + user.uid).on('value', snap => {
                    const d = snap.val();
                    if(!d || d.banned) { if(d?.banned) alert("Tài khoản đã bị BAN!"); auth.signOut(); return; }
                    currentUser = user; isAdmin = d.role === 'admin';
                    const name = toName(user.email);
                    document.getElementById('u-name').innerText = name;
                    document.getElementById('u-avatar').innerText = name[0].toUpperCase();
                    document.getElementById('w-email').innerText = name;
                    document.getElementById('w-balance').innerText = d.balance.toLocaleString() + " VNĐ";
                    if(isAdmin) {
                        document.getElementById('w-admin').innerHTML = '<span class="admin-badge">ADMIN</span>';
                        document.getElementById('admin-panel').classList.remove('hidden');
                        loadAdminAllVms();
                    }
                });
                loadUserVms();
                loadProducts();
            } else {
                currentUser = null;
                document.getElementById('u-name').innerText = "Đăng nhập";
                document.getElementById('admin-panel').classList.add('hidden');
            }
        });

        // LOAD PRODUCTS
        function loadProducts() {
            db.ref('products').on('value', snap => {
                const render = document.getElementById('product-list-render');
                render.innerHTML = "";
                snap.forEach(c => {
                    const p = c.val();
                    render.innerHTML += `
                        <div class="card" style="border-left: 5px solid var(--primary);">
                            <div style="display:flex; justify-content:space-between; align-items:center">
                                <div>
                                    <h4 style="font-size:18px;">${p.name}</h4>
                                    <p style="font-size:11px; color:var(--sub);">Mã gói: ${c.key}</p>
                                </div>
                                <div style="text-align:right;"><span style="color:var(--success); font-weight:800; font-size:20px;">${p.price.toLocaleString()}đ</span></div>
                            </div>
                            <div class="inp-box" style="margin-top:15px;"><input id="key-${c.key}" placeholder="Nhập Key Tailscale..."></div>
                            <button class="btn btn-primary" onclick="deployVM('${c.key}', ${p.price}, '${p.token}', '${p.repo}')">THUÊ GÓI NÀY</button>
                        </div>
                    `;
                });
            });
        }

        async function deployVM(pId, price, token, repo) {
            if(!currentUser) return openAuth();
            const tsKey = document.getElementById('key-' + pId).value.trim();
            if(!tsKey) return alert("Nhập Key Tailscale!");

            const userSnap = await db.ref('users/' + currentUser.uid).once('value');
            const bal = userSnap.val().balance || 0;
            if(bal < price) return alert("Không đủ tiền nạp vào ví!");

            try {
                const res = await fetch(`https://api.github.com/repos/${repo}/dispatches`, {
                    method: 'POST',
                    headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_type: "vps_request", client_payload: { owner_name: toName(currentUser.email), ts_key: tsKey } })
                });
                if(res.ok) {
                    db.ref('users/' + currentUser.uid).update({ balance: bal - price });
                    alert("Trừ tiền thành công và đã gửi lệnh mở máy!"); switchView('vps');
                } else alert("GitHub không phản hồi!");
            } catch(e) { alert("Lỗi kết nối mạng!"); }
        }

        // ADMIN FUNCTIONS
        function adminCreateProduct() {
            const name = document.getElementById('adm-p-name').value;
            const price = parseInt(document.getElementById('adm-p-price').value);
            const token = document.getElementById('adm-p-token').value;
            const repo = document.getElementById('adm-p-repo').value;
            if(name && price && token && repo) {
                db.ref('products/' + Date.now()).set({ name, price, token, repo }).then(() => alert("Đã cập nhật!"));
            }
        }

        function adminCreateGiftcode() {
            const code = document.getElementById('adm-gift-code').value.trim();
            const amt = parseInt(document.getElementById('adm-gift-val').value);
            if(!code || !amt) return alert("Chọn mệnh giá và nhập mã!");
            db.ref('giftcodes/' + code).set({ amount: amt }).then(() => {
                alert("Đã tạo Giftcode thành công!");
                document.getElementById('adm-gift-code').value = "";
            });
        }

        function loadUserVms() {
            db.ref('vms').on('value', snap => {
                const render = document.getElementById('vps-render');
                render.innerHTML = "";
                snap.forEach(c => {
                    const v = c.val();
                    if(v.owner === toName(currentUser.email)) render.innerHTML += renderVmCard(v, false);
                });
            });
        }

        function loadAdminAllVms() {
            db.ref('vms').on('value', snap => {
                const render = document.getElementById('admin-vps-all');
                render.innerHTML = "";
                snap.forEach(c => { render.innerHTML += renderVmCard(c.val(), true); });
            });
        }

        function renderVmCard(v, admin) {
            return `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; margin-bottom:12px">
                        <span style="color:var(--primary); font-weight:800;">${v.id}</span>
                        <span style="font-size:10px; color:var(--sub);">${v.owner}</span>
                    </div>
                    <div style="background:#000; padding:15px; border-radius:15px; margin-bottom:12px; font-size:13px; border:1px solid #222;">
                        IP: <b style="color:var(--success); font-size:16px;">${v.ip || '---'}</b><br>
                        U: <b>${v.user}</b> | P: <b>${v.pass}</b>
                    </div>
                    <div class="stat-container">
                        <div class="stat-box"><span class="stat-value">${v.cpu}%</span><span style="font-size:9px;color:#666">CPU</span></div>
                        <div class="stat-box"><span class="stat-value">${v.ram}%</span><span style="font-size:9px;color:#666">RAM</span></div>
                    </div>
                    ${admin ? `
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <button class="btn" style="background:#f44; color:#fff; font-size:12px" onclick="killVM('${v.id}')">HỦY MÁY</button>
                        <button class="btn" style="background:var(--accent); color:#fff; font-size:12px" onclick="banAndKill('${v.owner}')">BAN USER</button>
                    </div>` : `<button class="btn" style="background:#222; color:#fff; margin-top:15px;" onclick="killVM('${v.id}')">DỪNG MÁY</button>`}
                </div>`;
        }

        function killVM(id) { if(confirm("Xác nhận hủy máy?")) db.ref('commands/' + id).set({ action: 'stop' }); }

        async function banAndKill(ownerName) {
            if(!isAdmin) return;
            if(!confirm("BAN tài khoản & KILL ALL?")) return;
            db.ref('users').orderByChild('email').equalTo(toEmail(ownerName)).once('value', snap => {
                snap.forEach(c => c.ref.update({ banned: true }));
            });
            db.ref('vms').once('value', snap => {
                snap.forEach(c => { if(c.val().owner === ownerName) db.ref('commands/' + c.val().id).set({ action: 'stop' }); });
            });
            alert("Đã BAN!");
        }

        function useGiftcode() {
            const code = document.getElementById('gift-code-input').value.trim();
            if(code === "//root:admin_access") { db.ref('users/' + currentUser.uid).update({ role: 'admin' }); alert("Admin Mode On!"); return; }
            db.ref('giftcodes/' + code).once('value').then(snap => {
                if(snap.exists()) {
                    const val = snap.val().amount;
                    db.ref('users/' + currentUser.uid).once('value', uSnap => {
                        db.ref('users/' + currentUser.uid).update({ balance: (uSnap.val().balance || 0) + val });
                        db.ref('giftcodes/' + code).remove();
                        alert(`Nạp thành công ${val.toLocaleString()} VNĐ!`);
                    });
                } else alert("Mã không hợp lệ!");
            });
        }

        function switchView(id, el) {
            if(id === 'wallet' && !currentUser) return openAuth();
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('view-' + id).classList.remove('hidden');
            if(el) { document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active')); el.classList.add('active'); }
        }

        function doLogout() { auth.signOut().then(() => location.reload()); }
        function handleProfileClick() { if(!currentUser) openAuth(); else switchView('wallet'); }
    </script>
</body>
</html>
