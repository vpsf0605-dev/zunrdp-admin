<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZUNRDP | QU·∫¢N TR·ªä VI√äN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: sans-serif; background: #020617; color: #e2e8f0; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
        .status-on { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; }
        .info-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 15px; font-size: 11px; border: 1px solid rgba(255,255,255,0.05); }
        .copy-link { color: #3b82f6; font-weight: bold; cursor: pointer; margin-left: 8px; font-size: 10px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center py-6">
            <h1 class="text-3xl font-black italic text-blue-500 tracking-tighter">ZUNRDP</h1>
            <div class="flex gap-2">
                <button onclick="document.getElementById('create-modal').style.display='flex'" class="w-12 h-12 glass flex items-center justify-center text-blue-400"><i class="fas fa-plus"></i></button>
                <div class="glass px-4 py-2 text-center border-blue-500/30">
                    <span id="count" class="text-xl font-black text-blue-500">0</span>
                    <span class="text-[8px] block opacity-50 uppercase font-bold">Online</span>
                </div>
            </div>
        </header>

        <div id="vm-list" class="space-y-6"></div>
    </div>

    <div id="create-modal" class="modal">
        <div class="glass w-full max-w-xs p-6 border-white/10">
            <h3 class="text-xl font-bold mb-4 text-white">üöÄ Kh·ªüi T·∫°o M√°y</h3>
            <input type="password" id="gh-token" placeholder="GitHub Token" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm outline-none mb-3">
            <input type="text" id="owner-input" placeholder="T√™n ng∆∞·ªùi t·∫°o (Admin)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm outline-none mb-3">
            <div class="flex gap-3 mt-2">
                <button onclick="document.getElementById('create-modal').style.display='none'" class="flex-1 text-xs font-bold opacity-50">H·ª¶Y</button>
                <button onclick="triggerDeploy()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-xs">DEPLOY</button>
            </div>
        </div>
    </div>

    <script>
        const API = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app";
        const REPO = "vpsf0605-dev/zunrdp-Cloud";
        let activeTimers = {};

        async function triggerDeploy() {
            const token = document.getElementById('gh-token').value;
            const owner = document.getElementById('owner-input').value;
            if(!token || !owner) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
            
            const res = await fetch(`https://api.github.com/repos/${REPO}/actions/workflows/vm.yml/dispatches`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github.v3+json' },
                body: JSON.stringify({ ref: 'main', inputs: { machine_name: 'Windows', owner_name: owner } })
            });
            if(res.status === 204) {
                alert("‚úÖ ƒê√£ g·ª≠i l·ªánh t·∫°o m√°y th√†nh c√¥ng!");
                document.getElementById('create-modal').style.display = 'none';
            } else {
                alert("‚ùå L·ªói! Ki·ªÉm tra l·∫°i Token ho·∫∑c Repo.");
            }
        }

        async function refresh() {
            try {
                const res = await fetch(`${API}/vms.json`);
                const data = await res.json() || {};
                let html = '', c = 0;
                for (let id in data) {
                    const vm = data[id];
                    if (Date.now() - vm.lastSeen > 60000) continue;
                    c++;
                    const timerStatus = activeTimers[id] ? `<span class="bg-yellow-500/20 text-yellow-500 text-[10px] px-2 py-1 rounded-lg border border-yellow-500/20 ml-2 font-bold">‚è± ${activeTimers[id].label}</span>` : '';
                    html += `
                    <div class="glass p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2">
                                <div class="status-on"></div>
                                <b class="text-lg">${vm.id}</b> ${timerStatus}
                            </div>
                            <span class="text-[9px] opacity-30 font-bold uppercase tracking-widest">${vm.os}</span>
                        </div>
                        
                        <div class="info-box space-y-2 mb-4 font-mono">
                            <div class="flex justify-between"><span class="opacity-40 uppercase">Ng∆∞·ªùi t·∫°o:</span> <b class="text-blue-400">${vm.owner || 'Admin'}</b></div>
                            <div class="flex justify-between"><span class="opacity-40 uppercase">IP M√°y:</span> <span><b>${vm.ip}</b><span onclick="navigator.clipboard.writeText('${vm.ip}');alert('ƒê√£ Copy IP')" class="copy-link">COPY</span></span></div>
                            <div class="flex justify-between"><span class="opacity-40 uppercase">T√†i kho·∫£n:</span> <span><b>ADMINZUN</b><span onclick="navigator.clipboard.writeText('ADMINZUN')" class="copy-link">COPY</span></span></div>
                            <div class="flex justify-between"><span class="opacity-40 uppercase">M·∫≠t kh·∫©u:</span> <span><b>ZunRDP@123456</b><span onclick="navigator.clipboard.writeText('ZunRDP@123456')" class="copy-link">COPY</span></span></div>
                        </div>

                        <div class="flex gap-2">
                            <div class="flex-1 glass bg-black/40 flex items-center px-3 h-12 border-white/5">
                                <input type="number" id="val-${id}" placeholder="S·ªë" class="w-full bg-transparent outline-none text-center font-bold">
                                <select id="unit-${id}" class="bg-transparent text-[10px] font-bold text-blue-500 uppercase outline-none ml-2 border-l border-white/10 pl-2">
                                    <option value="60">Ph√∫t</option>
                                    <option value="1">Gi√¢y</option>
                                    <option value="3600">Gi·ªù</option>
                                </select>
                                <button onclick="sendTimer('${id}')" class="ml-4 text-blue-500"><i class="fas fa-clock text-xl"></i></button>
                            </div>
                            <button onclick="kill('${id}')" class="w-12 h-12 bg-red-500/10 text-red-500 rounded-xl border border-red-500/10"><i class="fas fa-power-off"></i></button>
                        </div>
                    </div>`;
                }
                document.getElementById('vm-list').innerHTML = html || '<p class="text-center opacity-20 py-10 font-bold uppercase text-[10px]">ƒêang qu√©t m√°y ·∫£o...</p>';
                document.getElementById('count').innerText = c;
            } catch (e) {}
        }

        async function sendTimer(id) {
            const v = document.getElementById(`val-${id}`).value;
            const u = document.getElementById(`unit-${id}`).value;
            if(!v || v < 1) return;
            const totalSeconds = parseInt(v * u);
            await fetch(`${API}/commands/${id}.json`, { method: 'PUT', body: JSON.stringify(`kill_in_${totalSeconds}`) });
            alert("‚è∞ ƒê√£ ƒë·∫∑t h·∫πn gi·ªù! M√°y ·∫£o s·∫Ω t·ª± s·∫≠p ngu·ªìn.");
            let s = totalSeconds;
            if(activeTimers[id]) clearInterval(activeTimers[id].itv);
            activeTimers[id] = { label: format(s), itv: setInterval(() => {
                s--; activeTimers[id].label = format(s);
                if(s<=0) { clearInterval(activeTimers[id].itv); delete activeTimers[id]; }
                refresh();
            }, 1000)};
            refresh();
        }

        function format(s) {
            let h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
            return `${h>0?h+'h ':''}${m}m ${sec}s`;
        }

        async function kill(id) {
            if(confirm("T·∫Øt m√°y ngay l·∫≠p t·ª©c?")) await fetch(`${API}/commands/${id}.json`, { method: 'PUT', body: JSON.stringify('kill') });
        }

        setInterval(refresh, 5000); refresh();
    </script>
</body>
</html>

