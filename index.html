<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZUNRDP | PREMIUM ADMIN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { background: #0a0c10; color: #f8fafc; font-family: 'Inter', sans-serif; background-image: radial-gradient(circle at 50% -20%, #1e293b 0%, #0a0c10 100%); min-height: 100vh; }
        .zun-logo { font-weight: 800; font-size: 26px; background: linear-gradient(135deg, #fff 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -1px; }
        .card { background: rgba(30, 41, 59, 0.3); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 24px; padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        #search-container { display: flex; align-items: center; background: rgba(255,255,255,0.05); border-radius: 14px; padding: 0 12px; border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s; width: 40px; overflow: hidden; }
        #search-container.active { width: 160px; background: rgba(255,255,255,0.1); border-color: rgba(59, 130, 246, 0.4); }
        #search-input { background: transparent; border: none; color: white; outline: none; font-size: 13px; width: 100%; margin-left: 10px; }
        .btn-plus { width: 40px; height: 40px; background: #3b82f6; border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-plus:active { transform: scale(0.9); }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-md mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <div class="zun-logo">ZUN<span>RDP</span></div>
                <div class="text-[9px] text-slate-500 font-bold uppercase tracking-[3px]">Cloud Management</div>
            </div>
            
            <div class="flex items-center gap-2">
                <div id="search-container">
                    <i class="fas fa-search text-slate-400" onclick="document.getElementById('search-container').classList.toggle('active'); document.getElementById('search-input').focus();"></i>
                    <input type="text" id="search-input" placeholder="Tìm...">
                </div>

                <div class="btn-plus" onclick="openCreateModal()"><i class="fas fa-plus text-white"></i></div>

                <div class="bg-blue-600/10 border border-blue-500/20 px-3 py-1.5 rounded-2xl text-center">
                    <span id="node-count" class="text-xl font-black text-blue-400">0</span>
                </div>
            </div>
        </header>

        <div id="list" class="space-y-5"></div>
    </div>

    <div id="create-modal" class="modal">
        <div class="bg-[#1e293b] w-full max-w-sm rounded-3xl p-6 border border-white/10">
            <h3 class="text-xl font-bold mb-4">Tạo Máy Ảo Mới</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-slate-400 font-bold uppercase">GitHub Token (Nhập 1 lần)</label>
                    <input type="password" id="gh-token" class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 outline-none mt-1 text-sm">
                </div>
                <div>
                    <label class="text-[10px] text-slate-400 font-bold uppercase">Hệ điều hành</label>
                    <select id="os-choice" class="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 outline-none mt-1 text-sm">
                        <option value="Windows">Windows Server 2025</option>
                        <option value="Ubuntu">Ubuntu 22.04</option>
                    </select>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="closeModal()" class="flex-1 bg-white/5 py-3 rounded-xl font-bold text-xs">HỦY</button>
                    <button onclick="triggerGitHubAction()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold text-xs">TẠO NGAY</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[300] opacity-0 transition-all duration-300 pointer-events-none">
        <div class="bg-white text-black px-6 py-3 rounded-2xl font-bold text-xs shadow-2xl" id="toast-msg"></div>
    </div>

    <script>
        const FIREBASE_API = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app";
        const GITHUB_REPO = "vpsf0605-dev/zunrdp-Cloud";
        
        // Tên chủ sở hữu từ Web (Giả sử bạn đã có bước nhập tên trước đó)
        let webUser = localStorage.getItem('zun_user') || "Admin";

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2000);
        }

        function openCreateModal() {
            document.getElementById('create-modal').style.display = 'flex';
            const savedToken = localStorage.getItem('gh_token');
            if(savedToken) document.getElementById('gh-token').value = savedToken;
        }

        function closeModal() { document.getElementById('create-modal').style.display = 'none'; }

        async function triggerGitHubAction() {
            const token = document.getElementById('gh-token').value;
            const os = document.getElementById('os-choice').value;
            
            if(!token) return alert("Vui lòng nhập Token GitHub!");
            localStorage.setItem('gh_token', token); // Ghi nhớ token

            showToast("Đang gửi yêu cầu tạo VM...");

            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/actions/workflows/vm.yml/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        ref: 'main',
                        inputs: {
                            machine_name: os,
                            owner_name: webUser // Tự động lấy tên ghi trên web
                        }
                    })
                });

                if(response.ok) {
                    showToast("✅ Đã bắt đầu tạo máy ảo!");
                    setTimeout(closeModal, 1000);
                } else {
                    alert("Lỗi: Token sai hoặc không có quyền!");
                }
            } catch (e) { alert("Lỗi kết nối GitHub!"); }
        }

        // Logic Fetch và Render danh sách (giống bản cũ bạn đã có)
        async function fetchData() {
            try {
                const res = await fetch(`${FIREBASE_API}/vms.json`);
                const data = await res.json() || {};
                const container = document.getElementById('list');
                let html = ''; let count = 0;
                for(let id in data) {
                    const vm = data[id];
                    const diff = Math.floor((Date.now() - vm.lastSeen) / 1000);
                    if(diff > 60) continue;
                    count++;
                    html += `<div class="card"><h3 class="font-bold text-xl">${vm.id}</h3><p class="text-xs text-blue-400">${vm.ip}</p></div>`;
                }
                container.innerHTML = html || '<p class="text-center opacity-20 py-10">Trống</p>';
                document.getElementById('node-count').innerText = count;
            } catch(e){}
        }
        setInterval(fetchData, 5000); fetchData();
    </script>
</body>
</html>

