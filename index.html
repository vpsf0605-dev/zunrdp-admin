<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZUNRDP | CLOUD SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; min-height: 100vh; }
        .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; }
        .bg-mesh { background-image: radial-gradient(at 0% 0%, rgba(30, 64, 175, 0.2) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.15) 0px, transparent 50%); }
        input, select { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 14px; outline: none; color: white; }
        input:focus { border-color: #3b82f6; }
    </style>
</head>
<body class="bg-mesh p-4">

    <div id="auth-screen" class="min-h-screen flex items-center justify-center">
        <div class="glass p-8 w-full max-w-sm">
            <h1 class="text-3xl font-black italic text-center mb-8">ZUNRDP <span class="text-blue-500">CLOUD</span></h1>
            
            <div id="login-form" class="space-y-4">
                <input type="text" id="l-user" placeholder="Username" class="w-full">
                <input type="password" id="l-pass" placeholder="Password" class="w-full">
                <button onclick="login()" class="w-full bg-blue-600 py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-blue-500 transition">ƒêƒÉng Nh·∫≠p</button>
                <p class="text-center text-xs opacity-50">Ch∆∞a c√≥ t√†i kho·∫£n? <a href="javascript:toggleAuth()" class="text-blue-400 font-bold">ƒêƒÉng k√Ω ngay</a></p>
            </div>

            <div id="reg-form" class="space-y-4 hidden">
                <input type="text" id="r-user" placeholder="T√™n t√†i kho·∫£n m·ªõi" class="w-full">
                <input type="password" id="r-pass" placeholder="M·∫≠t kh·∫©u" class="w-full">
                <button onclick="register()" class="w-full bg-green-600 py-4 rounded-xl font-bold uppercase tracking-widest hover:bg-green-500 transition">T·∫°o T√†i Kho·∫£n</button>
                <p class="text-center text-xs opacity-50">ƒê√£ c√≥ t√†i kho·∫£n? <a href="javascript:toggleAuth()" class="text-blue-400 font-bold">Quay l·∫°i</a></p>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden max-w-4xl mx-auto py-8">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h2 id="welcome-msg" class="text-2xl font-black italic">CH√ÄO M·ª™NG</h2>
                <span id="badge" class="text-[10px] font-bold text-blue-400 uppercase tracking-widest bg-blue-500/10 px-3 py-1 rounded-full border border-blue-500/20">Member</span>
            </div>
            <div class="flex gap-2">
                <button id="admin-btn" onclick="openAdmin()" class="hidden w-12 h-12 glass flex items-center justify-center text-yellow-500"><i class="fas fa-user-shield"></i></button>
                <button onclick="location.reload()" class="w-12 h-12 glass flex items-center justify-center text-red-500"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <div id="create-vm-section" class="hidden glass p-6 mb-10 border-l-8 border-blue-600">
            <h3 class="text-sm font-black uppercase mb-4 tracking-tighter text-blue-400"><i class="fas fa-rocket mr-2"></i> Kh·ªüi t·∫°o m√°y ·∫£o Windows</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="password" id="gh-token" placeholder="D√°n GitHub Token c·ªßa b·∫°n t·∫°i ƒë√¢y" class="text-xs">
                <button onclick="deployVM()" class="bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black text-xs uppercase transition shadow-xl shadow-blue-900/20">B·∫Øt ƒë·∫ßu t·∫°o VM</button>
            </div>
            <p class="text-[9px] opacity-30 mt-3 font-bold uppercase tracking-widest">L∆∞u √Ω: M√°y s·∫Ω ƒë∆∞·ª£c g·∫Øn tr·ª±c ti·∫øp v√†o t√†i kho·∫£n c·ªßa b·∫°n</p>
        </div>

        <div id="vm-list" class="grid gap-6"></div>
    </div>

    <div id="admin-panel" class="fixed inset-0 bg-black/95 z-50 hidden p-6 overflow-y-auto">
        <div class="max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black italic">QU·∫¢N L√ù TH√ÄNH VI√äN</h2>
                <button onclick="closeAdmin()" class="w-12 h-12 glass text-red-500 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="user-list-render" class="space-y-4"></div>
        </div>
    </div>

    <script>
        const API = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app";
        const REPO = "vpsf0605-dev/zunrdp-Cloud";
        let userSession = null;

        function toggleAuth() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('reg-form').classList.toggle('hidden');
        }

        // --- H·ªÜ TH·ªêNG ƒêƒÇNG K√ù / ƒêƒÇNG NH·∫¨P ---
        async function register() {
            const u = document.getElementById('r-user').value.trim();
            const p = document.getElementById('r-pass').value.trim();
            if(!u || !p) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß!");
            
            const check = await fetch(`${API}/users/${u}.json`);
            if(await check.json()) return alert("T√™n t√†i kho·∫£n ƒë√£ t·ªìn t·∫°i!");

            await fetch(`${API}/users/${u}.json`, {
                method: 'PUT',
                body: JSON.stringify({ password: p, canCreate: false, isBanned: false })
            });
            alert("ƒêƒÉng k√Ω th√†nh c√¥ng! H√£y ch·ªù Admin c·∫•p quy·ªÅn t·∫°o VM.");
            toggleAuth();
        }

        async function login() {
            const u = document.getElementById('l-user').value.trim();
            const p = document.getElementById('l-pass').value.trim();

            if(u === "ZunRdp" && p === "26082007ngoc") {
                userSession = { id: u, role: 'admin', canCreate: true };
            } else {
                const res = await fetch(`${API}/users/${u}.json`);
                const data = await res.json();
                if(data && data.password === p) {
                    if(data.isBanned) return alert("T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ b·ªã BAN!");
                    userSession = { id: u, role: 'user', ...data };
                } else { return alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!"); }
            }
            startDashboard();
        }

        function startDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = `XIN CH√ÄO, ${userSession.id}`;
            
            if(userSession.role === 'admin') {
                document.getElementById('admin-btn').classList.remove('hidden');
                document.getElementById('badge').innerText = "H·ªá th·ªëng t·ªëi cao";
            }
            if(userSession.canCreate) document.getElementById('create-vm-section').classList.remove('hidden');
            
            setInterval(fetchVMs, 2000);
        }

        // --- QU·∫¢N L√ù M√ÅY ·∫¢O & BI·ªÇU ƒê·ªí ---
        async function fetchVMs() {
            const res = await fetch(`${API}/vms.json`);
            const data = await res.json() || {};
            let html = '';
            for(let id in data) {
                const vm = data[id];
                // L·ªåC: User th∆∞·ªùng ch·ªâ th·∫•y m√°y m√¨nh, Admin th·∫•y h·∫øt
                if(userSession.role !== 'admin' && vm.owner !== userSession.id) continue;
                if(Date.now() - vm.lastSeen > 60000) continue;

                html += `
                <div class="glass p-6 border-l-4 border-blue-500/50">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h4 class="text-xl font-black text-white tracking-tighter">${vm.id}</h4>
                            <p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">S·ªü h·ªØu: ${vm.owner}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-[8px] opacity-40 uppercase font-bold block mb-1">Th·ªùi gian ch·∫°y</span>
                            <span class="text-xs font-mono font-bold text-white bg-blue-500/20 px-2 py-1 rounded-lg">
                                ${Math.floor((Date.now()-vm.startTime)/60000)} Ph√∫t
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-black/40 p-4 rounded-2xl border border-white/5">
                            <div class="flex justify-between text-[10px] font-bold mb-2 uppercase opacity-50"><span>CPU</span><span>${vm.cpu}%</span></div>
                            <div class="h-1.5 bg-white/10 rounded-full overflow-hidden"><div class="bg-blue-500 h-full transition-all duration-500" style="width:${vm.cpu}%"></div></div>
                        </div>
                        <div class="bg-black/40 p-4 rounded-2xl border border-white/5">
                            <div class="flex justify-between text-[10px] font-bold mb-2 uppercase opacity-50"><span>RAM</span><span>${vm.ram}%</span></div>
                            <div class="h-1.5 bg-white/10 rounded-full overflow-hidden"><div class="bg-green-500 h-full transition-all duration-500" style="width:${vm.ram}%"></div></div>
                        </div>
                    </div>

                    <div class="bg-black/30 p-4 rounded-2xl text-[11px] font-bold space-y-2 mb-6 border border-white/5">
                        <div class="flex justify-between"><span class="opacity-30">IP ADDRESS:</span><span class="text-blue-400">${vm.ip}</span></div>
                        <div class="flex justify-between border-t border-white/5 pt-2"><span class="opacity-30">USER/PASS:</span><span>ADMINZUN / ZunRDP@123456</span></div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="navigator.clipboard.writeText('${vm.ip}')" class="flex-1 h-12 glass hover:bg-white/5 text-[10px] font-bold uppercase">Copy IP</button>
                        <button onclick="killVM('${id}')" class="w-12 h-12 bg-red-500/10 text-red-500 border border-red-500/20 rounded-xl hover:bg-red-600 hover:text-white transition flex items-center justify-center"><i class="fas fa-power-off"></i></button>
                    </div>
                </div>`;
            }
            document.getElementById('vm-list').innerHTML = html || '<div class="text-center py-20 opacity-20 italic">Ch∆∞a c√≥ m√°y ·∫£o n√†o ƒëang ch·∫°y.</div>';
        }

        // --- H√ÄM T·∫†O VM G·ª¨I T√àM OWNER ---
        async function deployVM() {
            const token = document.getElementById('gh-token').value;
            if(!token) return alert("Nh·∫≠p Token!");
            
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}/actions/workflows/vm.yml/dispatches`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ ref: 'main', inputs: { machine_name: 'Windows', owner_name: userSession.id } })
                });
                if(res.ok) alert("üöÄ ƒê√£ g·ª≠i l·ªánh kh·ªüi t·∫°o VM! ƒê·ª£i 2-3 ph√∫t m√°y s·∫Ω hi·ªán l√™n Dashboard.");
                else alert("‚ùå Token sai ho·∫∑c GitHub l·ªói!");
            } catch(e) { alert("L·ªói k·∫øt n·ªëi!"); }
        }

        // --- ADMIN QU·∫¢N L√ù ---
        async function openAdmin() {
            document.getElementById('admin-panel').classList.remove('hidden');
            const res = await fetch(`${API}/users.json`);
            const users = await res.json() || {};
            let html = '';
            for(let name in users) {
                const u = users[name];
                html += `
                <div class="glass p-5 flex justify-between items-center border-l-4 ${u.isBanned ? 'border-red-500' : 'border-green-500'}">
                    <div>
                        <p class="font-bold text-white">${name}</p>
                        <p class="text-[9px] font-bold ${u.canCreate ? 'text-green-400' : 'text-gray-500'} uppercase">Quy·ªÅn t·∫°o VM: ${u.canCreate ? 'C√ì' : 'KH√îNG'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateUser('${name}', {canCreate: !${u.canCreate}})" class="px-4 py-2 glass text-[9px] font-bold uppercase ${u.canCreate ? 'text-orange-400' : 'text-green-400'}">C·∫•p/H·ªßy quy·ªÅn</button>
                        <button onclick="updateUser('${name}', {isBanned: !${u.isBanned}})" class="w-10 h-10 glass text-red-500"><i class="fas ${u.isBanned ? 'fa-undo' : 'fa-ban'}"></i></button>
                    </div>
                </div>`;
            }
            document.getElementById('user-list-render').innerHTML = html;
        }

        async function updateUser(name, data) {
            await fetch(`${API}/users/${name}.json`, { method: 'PATCH', body: JSON.stringify(data) });
            if(data.isBanned) {
                // N·∫øu b·ªã Ban th√¨ t·∫Øt lu√¥n c√°c m√°y c·ªßa user ƒë√≥
                const vms = await (await fetch(`${API}/vms.json`)).json();
                for(let id in vms) if(vms[id].owner === name) killVM(id);
            }
            openAdmin();
        }

        async function killVM(id) {
            if(confirm("X√°c nh·∫≠n t·∫Øt m√°y ngay l·∫≠p t·ª©c?")) {
                await fetch(`${API}/vms/${id}.json`, { method: 'PATCH', body: JSON.stringify({ command: 'kill' }) });
            }
        }

        function closeAdmin() { document.getElementById('admin-panel').classList.add('hidden'); }
    </script>
</body>
</html>

