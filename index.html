<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZUNRDP PANEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #020617; color: white; font-family: sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        .btn-blue { background: linear-gradient(to right, #2563eb, #7c3aed); }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="main" class="max-w-md mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 id="user-tag" class="text-2xl font-bold italic uppercase">ZUNRDP</h1>
            <button onclick="openAdmin()" id="adm-btn" class="hidden text-yellow-500 text-xl"><i class="fas fa-crown"></i></button>
        </div>

        <div id="vm-count" class="text-blue-400 text-[10px] font-bold tracking-widest mb-6">0 MÁY ĐANG CHẠY</div>

        <div class="glass p-6 mb-8 border-l-4 border-blue-500">
            <p class="text-[10px] opacity-50 mb-2">NHẬP KEY ĐỂ TẠO MÁY</p>
            <input type="text" id="key-in" placeholder="Dán mã Key tại đây..." class="w-full p-4 bg-black/40 rounded-xl outline-none border border-white/5 mb-4 text-center font-bold">
            <button onclick="create()" id="btn-run" class="w-full btn-blue py-4 rounded-xl font-bold text-xs">KHỞI TẠO WINDOWS VM</button>
        </div>

        <div id="list" class="space-y-4"></div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/95 hidden p-6 z-50 overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold">QUẢN TRỊ VIÊN</h2>
            <button onclick="document.getElementById('modal').style.display='none'"><i class="fas fa-times text-2xl text-red-500"></i></button>
        </div>
        <div id="user-list" class="space-y-3"></div>
    </div>

    <script>
        const API = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app";
        const GITHUB = "TOKEN_CUA_BAN";
        const REPO = "vpsf0605-dev/zunrdp-Cloud";
        let me = { id: "Test", role: "admin" }; // Giả lập login, bạn hãy tích hợp code login của bạn vào đây

        async function create() {
            const k = document.getElementById('key-in').value;
            const btn = document.getElementById('btn-run');
            btn.innerText = "ĐANG GỬI..."; btn.disabled = true;
            
            const res = await fetch(`https://api.github.com/repos/${REPO}/actions/workflows/vm.yml/dispatches`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${GITHUB}` },
                body: JSON.stringify({ ref: 'main', inputs: { access_key: k } })
            });
            alert(res.ok ? "Đã gửi lệnh!" : "Lỗi gửi lệnh!");
            btn.innerText = "KHỞI TẠO WINDOWS VM"; btn.disabled = false;
        }

        async function load() {
            const vms = await fetch(`${API}/vms.json`).then(r => r.json()) || {};
            let h = ''; let c = 0;
            for(let id in vms) {
                const v = vms[id];
                // Admin thấy hết, User thấy máy của mình
                if(me.role !== 'admin' && v.owner !== me.id) continue;
                if(Date.now() - v.lastSeen > 60000) continue;
                c++;
                h += `
                <div class="glass p-5">
                    <div class="flex justify-between mb-4">
                        <span class="font-bold text-blue-400">${v.id}</span>
                        <span class="text-[9px] opacity-40 uppercase italic">${v.owner}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-4 text-[10px]">
                        <div class="bg-black/30 p-2 rounded-lg text-center">CPU: ${v.cpu}%</div>
                        <div class="bg-black/30 p-2 rounded-lg text-center">RAM: ${v.ram}%</div>
                    </div>
                    <div class="text-[10px] bg-black/60 p-3 rounded-lg mb-4 font-mono">
                        IP: <span class="text-green-400">${v.ip || 'Connecting...'}</span>
                    </div>
                    <button onclick="kill('${id}')" class="w-full py-2 bg-red-500/10 text-red-500 rounded text-[10px] font-bold">HỦY MÁY</button>
                </div>`;
            }
            document.getElementById('list').innerHTML = h || '<p class="opacity-20 text-center text-xs py-10">Không có máy nào online</p>';
            document.getElementById('vm-count').innerText = `${c} MÁY ĐANG HOẠT ĐỘNG`;
        }

        async function openAdmin() {
            document.getElementById('modal').style.display = 'block';
            const users = await fetch(`${API}/users.json`).then(r => r.json()) || {};
            let h = '';
            for(let n in users) {
                h += `<div class="glass p-4 flex justify-between items-center">
                    <div><p class="font-bold">${n}</p><p class="text-[9px] text-blue-400">${users[n].key}</p></div>
                    <div class="flex gap-2">
                        <button onclick="grant('${n}')" class="bg-blue-600 w-8 h-8 rounded"><i class="fas fa-key text-[10px]"></i></button>
                        <button onclick="ban('${n}')" class="bg-red-600 w-8 h-8 rounded"><i class="fas fa-ban text-[10px]"></i></button>
                    </div>
                </div>`;
            }
            document.getElementById('user-list').innerHTML = h;
        }

        async function kill(id) { if(confirm("Dừng máy?")) await fetch(`${API}/vms/${id}.json`, { method:'DELETE' }); }
        
        setInterval(load, 5000);
        if(me.role === 'admin') document.getElementById('adm-btn').classList.remove('hidden');
    </script>
</body>
</html>

