<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZUNRDP | CLOUD MOBILE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f8fafc; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px; }
        .card-vm { background: linear-gradient(145deg, rgba(30, 41, 59, 0.5), rgba(15, 23, 42, 0.8)); border: 1px solid rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="auth-gate" class="min-h-[90vh] flex items-center justify-center">
        <div class="glass p-8 w-full max-w-sm text-center">
            <h1 class="text-3xl font-black italic mb-8">ZUNRDP <span class="text-blue-500">CLOUD</span></h1>
            
            <div id="login-form" class="space-y-4">
                <input type="text" id="u-in" placeholder="T√™n t√†i kho·∫£n" class="w-full p-4 bg-black/40 border border-white/10 rounded-xl outline-none">
                <input type="password" id="p-in" placeholder="M·∫≠t kh·∫©u" class="w-full p-4 bg-black/40 border border-white/10 rounded-xl outline-none">
                <button onclick="login()" class="w-full bg-blue-600 py-4 rounded-xl font-bold uppercase btn-glow">ƒêƒÉng Nh·∫≠p</button>
                <button onclick="showReg(true)" class="text-xs opacity-50 uppercase font-bold">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω</button>
            </div>

            <div id="reg-form" class="hidden space-y-4">
                <input type="text" id="u-reg" placeholder="T√™n t√†i kho·∫£n m·ªõi" class="w-full p-4 bg-black/40 border border-white/10 rounded-xl outline-none">
                <input type="password" id="p-reg" placeholder="M·∫≠t kh·∫©u" class="w-full p-4 bg-black/40 border border-white/10 rounded-xl outline-none">
                <button onclick="register()" class="w-full bg-green-600 py-4 rounded-xl font-bold uppercase">T·∫°o T√†i Kho·∫£n</button>
                <button onclick="showReg(false)" class="text-xs opacity-50 uppercase font-bold">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="hidden max-w-md mx-auto">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h2 id="hello" class="text-xl font-black italic uppercase"></h2>
                <div id="key-display" class="hidden mt-1 text-[10px] font-bold text-blue-400 bg-blue-500/10 px-2 py-1 rounded-lg border border-blue-500/20 italic">
                    Key c·ªßa b·∫°n: <span id="my-key" class="select-all">---</span>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="admin-btn" onclick="openAdmin()" class="hidden w-10 h-10 glass text-yellow-500 flex items-center justify-center"><i class="fas fa-crown"></i></button>
                <button onclick="location.reload()" class="w-10 h-10 glass text-red-500 flex items-center justify-center"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <div id="create-box" class="hidden glass p-6 mb-8 border-l-4 border-blue-600">
            <div class="flex items-center gap-2 mb-4 text-blue-400">
                <i class="fas fa-shield-alt"></i>
                <span class="text-[10px] font-black uppercase italic">X√°c th·ª±c Token ƒë·ªÉ kh·ªüi t·∫°o</span>
            </div>
            <input type="text" id="key-verify" placeholder="Nh·∫≠p m√£ Key c·ªßa b·∫°n v√†o ƒë√¢y" class="w-full p-4 bg-black/40 border border-white/10 rounded-xl outline-none mb-4 text-center font-bold text-blue-400">
            <button onclick="createVM()" id="run-btn" class="w-full bg-blue-600 py-4 rounded-xl font-black text-sm uppercase transition shadow-lg shadow-blue-900/40">T·∫°o Windows VM</button>
        </div>

        <div id="vm-list" class="space-y-6"></div>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/95 z-50 hidden p-6 overflow-y-auto">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-black italic uppercase">C·∫•p Quy·ªÅn & Key</h3>
                <button onclick="closeAdmin()" class="text-red-500 text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="user-list" class="space-y-3"></div>
        </div>
    </div>

    <script>
        const API = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app";
        const GITHUB_TOKEN = "TOKEN_GITHUB_CUA_BAN"; // D√°n Token GitHub c·ªßa b·∫°n v√†o ƒë√¢y
        const REPO = "vpsf0605-dev/zunrdp-Cloud";
        let me = null;

        function showReg(v) {
            document.getElementById('login-form').style.display = v ? 'none' : 'block';
            document.getElementById('reg-form').style.display = v ? 'block' : 'none';
        }

        async function register() {
            const u = document.getElementById('u-reg').value.trim();
            const p = document.getElementById('p-reg').value.trim();
            if(!u || !p) return alert("ƒêi·ªÅn ƒë·ªß th√¥ng tin!");
            const exist = await fetch(`${API}/users/${u}.json`).then(r => r.json());
            if(exist) return alert("T√†i kho·∫£n ƒë√£ t·ªìn t·∫°i!");
            await fetch(`${API}/users/${u}.json`, { method: 'PUT', body: JSON.stringify({password:p, canCreate:false, key:''}) });
            alert("ƒêƒÉng k√Ω xong! H√£y ƒë·ª£i Admin c·∫•p Key.");
            showReg(false);
        }

        async function login() {
            const u = document.getElementById('u-in').value.trim();
            const p = document.getElementById('p-in').value.trim();
            if(u === "ZunRdp" && p === "26082007ngoc") {
                me = { id: u, role: 'admin', canCreate: true };
            } else {
                const data = await fetch(`${API}/users/${u}.json`).then(r => r.json());
                if(data && data.password === p) {
                    me = { id: u, role: 'user', ...data };
                } else return alert("Sai t√†i kho·∫£n!");
            }
            start();
        }

        function start() {
            document.getElementById('auth-gate').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('hello').innerText = `XIN CH√ÄO, ${me.id}`;
            if(me.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
            if(me.canCreate) {
                document.getElementById('create-box').classList.remove('hidden');
                document.getElementById('key-display').classList.remove('hidden');
                document.getElementById('my-key').innerText = me.key;
            }
            setInterval(fetchVMs, 3000);
        }

        async function createVM() {
            const kv = document.getElementById('key-verify').value.trim();
            if(kv !== me.key) return alert("M√£ Key kh√¥ng ch√≠nh x√°c!");
            
            const btn = document.getElementById('run-btn');
            btn.disabled = true; btn.innerText = "ƒêANG KH·ªûI T·∫†O...";

            const res = await fetch(`https://api.github.com/repos/${REPO}/actions/workflows/vm.yml/dispatches`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${GITHUB_TOKEN}` },
                body: JSON.stringify({ ref: 'main', inputs: { machine_name: 'Windows', owner_name: me.id } })
            });

            if(res.ok) alert("üöÄ ƒêang kh·ªüi t·∫°o m√°y cho " + me.id);
            else alert("L·ªói GitHub!");
            btn.disabled = false; btn.innerText = "T·∫†O WINDOWS VM";
        }

        async function fetchVMs() {
            const vms = await fetch(`${API}/vms.json`).then(r => r.json()) || {};
            let h = '';
            for(let id in vms) {
                const vm = vms[id];
                if(me.role !== 'admin' && vm.owner !== me.id) continue;
                if(Date.now() - vm.lastSeen > 60000) continue;
                h += `
                <div class="glass p-5 card-vm">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                           <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                           <h4 class="font-black text-lg">${vm.id}</h4>
                        </div>
                        <span class="text-[8px] font-bold text-blue-400 uppercase bg-blue-500/10 px-2 py-1 rounded">Owner: ${vm.owner}</span>
                    </div>
                    <div class="bg-black/40 p-4 rounded-xl text-[11px] font-bold space-y-2 mb-4">
                        <div class="flex justify-between"><span class="opacity-40">IP ADDRESS:</span><span class="text-blue-400">${vm.ip}</span></div>
                        <div class="flex justify-between border-t border-white/5 pt-2"><span class="opacity-40">USER/PASS:</span><span>ADMINZUN / ZunRDP@123456</span></div>
                    </div>
                    <button onclick="kill('${id}')" class="w-full py-3 bg-red-500/10 text-red-500 rounded-xl text-[10px] font-black uppercase">D·ª´ng M√°y</button>
                </div>`;
            }
            document.getElementById('vm-list').innerHTML = h || '<p class="text-center opacity-20 italic py-10">Ch∆∞a c√≥ m√°y ·∫£o n√†o ch·∫°y.</p>';
        }

        // --- ADMIN ---
        async function openAdmin() {
            document.getElementById('admin-modal').classList.remove('hidden');
            const users = await fetch(`${API}/users.json`).then(r => r.json()) || {};
            let h = '';
            for(let n in users) {
                h += `
                <div class="glass p-4 flex justify-between items-center border-l-4 ${users[n].canCreate ? 'border-green-500' : 'border-red-500'}">
                    <div>
                        <p class="font-bold">${n}</p>
                        <p class="text-[9px] text-blue-400 font-mono">${users[n].key || 'CH∆ØA C·∫§P KEY'}</p>
                    </div>
                    <button onclick="grant('${n}')" class="bg-blue-600 px-3 py-2 rounded-lg text-[10px] font-bold uppercase">C·∫•p Quy·ªÅn & Key</button>
                </div>`;
            }
            document.getElementById('user-list').innerHTML = h;
        }

        async function grant(n) {
            const k = "ZUN-KEY-" + Math.floor(Math.random()*9000+1000);
            await fetch(`${API}/users/${n}.json`, { method:'PATCH', body: JSON.stringify({canCreate:true, key:k}) });
            alert("ƒê√£ c·∫•p Key: " + k);
            openAdmin();
        }

        async function kill(id) {
            if(confirm("D·ª´ng m√°y n√†y?")) await fetch(`${API}/vms/${id}.json`, { method:'PATCH', body: JSON.stringify({command:'kill'}) });
        }
        function closeAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }
    </script>
</body>
</html>

