<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ZUNRDP | INTERNAL TOKEN SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #010413; color: #f8fafc; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 28px; }
        .creation-box { border-left: 10px solid #3b82f6; box-shadow: 0 20px 50px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="p-4 md:p-10">

    <div id="auth-gate" class="min-h-[80vh] flex items-center justify-center">
        <div class="glass p-10 w-full max-w-sm text-center">
            <h1 class="text-3xl font-black mb-8 italic">ZUNRDP <span class="text-blue-500">CLOUD</span></h1>
            <input type="text" id="user-in" placeholder="T√™n t√†i kho·∫£n" class="w-full p-4 mb-4 bg-black/40 border border-white/10 rounded-2xl outline-none">
            <input type="password" id="pass-in" placeholder="M·∫≠t kh·∫©u" class="w-full p-4 mb-6 bg-black/40 border border-white/10 rounded-2xl outline-none">
            <button onclick="login()" class="w-full bg-blue-600 py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-blue-500 transition">V√†o H·ªá Th·ªëng</button>
        </div>
    </div>

    <div id="dashboard" class="hidden max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h2 id="user-display" class="text-3xl font-black italic uppercase"></h2>
                <span class="text-[10px] text-blue-400 font-bold tracking-widest bg-blue-500/10 px-3 py-1 rounded-full">TH√ÄNH VI√äN ƒê√É X√ÅC MINH</span>
            </div>
            <button id="adm-btn" onclick="openAdmin()" class="hidden w-14 h-14 glass text-yellow-500 text-xl flex items-center justify-center"><i class="fas fa-crown"></i></button>
        </header>

        <div id="create-section" class="hidden glass p-8 mb-10 creation-box">
            <div class="flex items-center gap-3 mb-6">
                <i class="fas fa-key text-blue-500"></i>
                <h3 class="font-black uppercase text-sm tracking-widest">X√°c th·ª±c Token n·ªôi b·ªô ƒë·ªÉ t·∫°o m√°y</h3>
            </div>
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="internal-token" placeholder="Nh·∫≠p m√£ Token Admin c·∫•p cho b·∫°n" class="flex-1 p-5 bg-black/40 border border-white/10 rounded-2xl outline-none text-blue-400 font-bold">
                <button onclick="deployWithToken()" id="btn-run" class="bg-blue-600 px-10 py-5 rounded-2xl font-black text-xs uppercase hover:bg-blue-500 transition">Kh·ªüi T·∫°o Windows</button>
            </div>
        </div>

        <div id="vm-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/95 z-[100] hidden p-6 overflow-y-auto">
        <div class="max-w-3xl mx-auto">
            <div class="flex justify-between items-center mb-10 text-white">
                <h2 class="text-3xl font-black">QU·∫¢N L√ù TOKEN</h2>
                <button onclick="closeAdmin()" class="text-red-500 text-3xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="user-list" class="space-y-4"></div>
        </div>
    </div>

    <script>
        const API = "https://zunrdp-default-rtdb.asia-southeast1.firebasedatabase.app";
        const REPO = "vpsf0605-dev/zunrdp-Cloud";
        const MASTER_GH_TOKEN = "YOUR_ADMIN_GITHUB_TOKEN"; // QUAN TR·ªåNG: D√°n Token GitHub c·ªßa b·∫°n v√†o ƒë√¢y

        let session = null;

        async function login() {
            const u = document.getElementById('user-in').value;
            const p = document.getElementById('pass-in').value;
            if(u === "ZunRdp" && p === "26082007ngoc") {
                session = { id: u, role: 'admin' };
            } else {
                const data = await fetch(`${API}/users/${u}.json`).then(r => r.json());
                if(data && data.password === p && !data.isBanned) session = { id: u, role: 'user', ...data };
                else return alert("Sai t√†i kho·∫£n ho·∫∑c b·ªã BAN!");
            }
            showUI();
        }

        function showUI() {
            document.getElementById('auth-gate').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('user-display').innerText = `XIN CH√ÄO, ${session.id}`;
            if(session.role === 'admin') document.getElementById('adm-btn').classList.remove('hidden');
            if(session.canCreate) document.getElementById('create-section').classList.remove('hidden');
            setInterval(fetchVMs, 3000);
        }

        // --- C∆† CH·∫æ T·∫†O VM B·∫∞NG TOKEN N·ªòI B·ªò ---
        async function deployWithToken() {
            const inputToken = document.getElementById('internal-token').value.trim();
            const btn = document.getElementById('btn-run');

            // 1. Ki·ªÉm tra m√£ Token nh·∫≠p v√†o c√≥ ƒë√∫ng v·ªõi Token trong DB c·ªßa User kh√¥ng
            if(inputToken !== session.internalToken) {
                return alert("M√£ Token kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng ƒë√∫ng v·ªõi t√†i kho·∫£n n√†y!");
            }

            btn.disabled = true; btn.innerText = "ƒêANG X·ª¨ L√ù...";

            // 2. N·∫øu kh·ªõp, d√πng Token c·ªßa Admin ƒë·ªÉ g·ªçi GitHub t·∫°o m√°y cho th√†nh vi√™n
            const res = await fetch(`https://api.github.com/repos/${REPO}/actions/workflows/vm.yml/dispatches`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${MASTER_GH_TOKEN}` },
                body: JSON.stringify({ 
                    ref: 'main', 
                    inputs: { machine_name: 'Windows', owner_name: session.id } 
                })
            });

            if(res.ok) alert("üöÄ Th√†nh c√¥ng! M√°y ·∫£o ƒëang ƒë∆∞·ª£c kh·ªüi t·∫°o cho: " + session.id);
            else alert("L·ªói GitHub! Admin h√£y ki·ªÉm tra l·∫°i MASTER_GH_TOKEN.");
            btn.disabled = false; btn.innerText = "KH·ªûI T·∫†O WINDOWS";
        }

        async function fetchVMs() {
            const data = await fetch(`${API}/vms.json`).then(r => r.json()) || {};
            let html = '';
            for(let id in data) {
                const vm = data[id];
                if(session.role !== 'admin' && vm.owner !== session.id) continue;
                if(Date.now() - vm.lastSeen > 60000) continue;
                html += `
                <div class="glass p-8 border-l-4 border-blue-500">
                    <div class="flex justify-between mb-6">
                        <h4 class="text-xl font-black">${vm.id}</h4>
                        <span class="text-xs font-bold text-blue-400 uppercase">Ch·ªß: ${vm.owner}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-black/20 p-4 rounded-2xl">
                            <p class="text-[10px] opacity-40 mb-2">CPU USAGE</p>
                            <div class="h-1 bg-white/10 rounded-full"><div class="bg-blue-500 h-full" style="width:${vm.cpu}%"></div></div>
                        </div>
                        <div class="bg-black/20 p-4 rounded-2xl">
                            <p class="text-[10px] opacity-40 mb-2">RAM USAGE</p>
                            <div class="h-1 bg-white/10 rounded-full"><div class="bg-green-500 h-full" style="width:${vm.ram}%"></div></div>
                        </div>
                    </div>
                    <div class="bg-black/40 p-4 rounded-2xl text-xs font-mono space-y-2">
                        <p>IP: <span class="text-blue-400">${vm.ip}</span></p>
                        <p>User/Pass: ADMINZUN / ZunRDP@123456</p>
                    </div>
                </div>`;
            }
            document.getElementById('vm-grid').innerHTML = html;
        }

        async function openAdmin() {
            document.getElementById('admin-modal').classList.remove('hidden');
            const users = await fetch(`${API}/users.json`).then(r => r.json()) || {};
            let html = '';
            for(let name in users) {
                const u = users[name];
                html += `
                <div class="glass p-6 flex justify-between items-center bg-white/5 border-l-4 ${u.isBanned ? 'border-red-500':'border-green-500'}">
                    <div>
                        <p class="font-black text-xl">${name}</p>
                        <p class="text-[10px] text-blue-400">TOKEN HI·ªÜN T·∫†I: <span class="bg-blue-500/20 px-2 rounded">${u.internalToken || 'CH∆ØA C·∫§P'}</span></p>
                    </div>
                    <div class="flex gap-2 text-[10px] font-bold">
                        <button onclick="grantToken('${name}')" class="bg-blue-600 px-4 py-2 rounded-xl uppercase">C·∫•p Token & Quy·ªÅn</button>
                        <button onclick="ban('${name}')" class="bg-red-600 px-4 py-2 rounded-xl uppercase">Ban</button>
                    </div>
                </div>`;
            }
            document.getElementById('user-list').innerHTML = html;
        }

        async function grantToken(name) {
            const newToken = "ZUN-" + Math.floor(Math.random() * 9000 + 1000);
            await fetch(`${API}/users/${name}.json`, { 
                method: 'PATCH', 
                body: JSON.stringify({ canCreate: true, internalToken: newToken }) 
            });
            alert("ƒê√£ c·∫•p Token: " + newToken + " cho " + name);
            openAdmin();
        }

        function closeAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }
    </script>
</body>
</html>

